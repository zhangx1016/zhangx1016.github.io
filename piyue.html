<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Word作业批改助手 V10.0</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root { --accent: #2563eb; --bg: #f8fafc; }
        body { font-family: 'PingFang SC', sans-serif; background: var(--bg); padding: 20px; }
        .main-card { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: var(--accent); font-size: 24px; margin-bottom: 30px; }
        .upload-area { border: 2px dashed #e2e8f0; padding: 20px; border-radius: 10px; margin-bottom: 15px; background: #fff; }
        button { width: 100%; background: var(--accent); color: white; border: none; padding: 16px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        button:disabled { background: #94a3b8; }
        #console { background: #1e293b; color: #38bdf8; padding: 15px; border-radius: 8px; height: 250px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 13px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="main-card">
    <h1>Word批改助手 V10.0 - 深度修复版</h1>
    <div class="upload-area"><strong>1. 成绩单 (Excel)：</strong><input type="file" id="exIn" accept=".xlsx, .xls"></div>
    <div class="upload-area"><strong>2. 作业文档 (Word)：</strong><input type="file" id="wdIn" accept=".docx" multiple></div>
    <button id="goBtn" onclick="run()" disabled>执行批改 (汇总表重构模式)</button>
    <div id="console">系统就绪，请先上传 Excel 成绩单。</div>
</div>

<script>
    let db = {};
    let okEx = false, okWd = false;

    // --- 1. 数据解析 ---
    document.getElementById('exIn').addEventListener('change', async (e) => {
        const rows = XLSX.utils.sheet_to_json(XLSX.read(await e.target.files[0].arrayBuffer()).Sheets[XLSX.read(await e.target.files[0].arrayBuffer()).SheetNames[0]], {header:1});
        const h = rows[0].map(s => String(s).trim());
        const m = { id: h.indexOf("学号"), n: h.indexOf("姓名"), s: [h.indexOf("1"), h.indexOf("2"), h.indexOf("3"), h.indexOf("4")], t: h.findIndex(s=>s.includes("合计")) };
        rows.slice(1).forEach(r => { if(r[m.id]) db[String(r[m.id]).trim()] = { name: r[m.n], sc: m.s.map(i => r[i]), tot: r[m.t] }; });
        msg("Excel 加载成功！"); okEx = true; check();
    });

    document.getElementById('wdIn').addEventListener('change', () => { okWd = true; check(); msg("Word 文档已添加。"); });
    function check() { document.getElementById('goBtn').disabled = !(okEx && okWd); }
    function msg(t) { const c = document.getElementById('console'); c.innerText += `\n> ${t}`; c.scrollTop = c.scrollHeight; }

    // --- 2. 主逻辑 ---
    async function run() {
        const btn = document.getElementById('goBtn');
        btn.disabled = true;
        const files = document.getElementById('wdIn').files;
        const zip = new JSZip();

        for (let file of files) {
            try {
                const docZip = await JSZip.loadAsync(await file.arrayBuffer());
                let xml = await docZip.file("word/document.xml").async("string");
                const doc = new DOMParser().parseFromString(xml, "application/xml");

                // 匹配学生
                let stu = null;
                const txt = doc.documentElement.textContent;
                for (let id in db) { if (file.name.includes(id) || txt.includes(id)) { stu = db[id]; break; } }
                if (!stu) continue;

                // A. 汇总表强制填分 (处理空单元格)
                const tbls = doc.getElementsByTagName("w:tbl");
                for (let tbl of tbls) {
                    const rs = tbl.getElementsByTagName("w:tr");
                    for (let r of rs) {
                        const rTxt = r.textContent;
                        const cells = r.getElementsByTagName("w:tc");
                        if (cells.length < 2) continue;
                        const lastCell = cells[cells.length - 1];

                        if (rTxt.includes("黑龙江工商学院简介")) forceFill(lastCell, stu.sc[0]);
                        else if (rTxt.includes("Excel综合实验")) forceFill(lastCell, stu.sc[1]);
                        else if (rTxt.includes("校园周边环境")) forceFill(lastCell, stu.sc[2]);
                        else if (rTxt.includes("MS Office综合练习")) forceFill(lastCell, stu.sc[3]);
                        else if (rTxt.includes("最终实验成绩")) forceFill(lastCell, stu.tot);
                    }
                }

                // B. 详情页成绩与打钩
                const ps = Array.from(doc.getElementsByTagName("w:p"));
                let expI = -1;
                for (let i = 0; i < ps.length; i++) {
                    const pt = ps[i].textContent;
                    if (pt.includes("1、实验步骤编写明确")) expI++;
                    if (expI >= 0 && expI < 4) {
                        const s = parseFloat(stu.sc[expI]);
                        if (pt.includes("1、实验步骤编写明确")) doCheck(ps[i], s >= 30);
                        else if (pt.includes("2、实验步骤编写基本明确")) doCheck(ps[i], s >= 20 && s < 30);
                        else if (pt.includes("3、实验步骤编写不清晰")) doCheck(ps[i], s < 20);
                        if (pt.includes("成绩")) doScore(ps[i], stu.sc[expI]);
                    }
                }

                docZip.file("word/document.xml", new XMLSerializer().serializeToString(doc));
                zip.file(`已批_${stu.name}_${file.name}`, await docZip.generateAsync({type:"blob"}));
                msg(`完成: ${stu.name}`);
            } catch (e) { msg(`错误: ${file.name}`); }
        }
        saveAs(await zip.generateAsync({type:"blob"}), "V10_终极修复结果.zip");
        btn.disabled = false;
    }

    // --- 3. 核心修复工具 ---

    // 解决“单元格为空”无法填入的关键：强制创建节点
    function forceFill(cell, val) {
        if (!cell) return;
        let p = cell.getElementsByTagName("w:p")[0];
        if (!p) p = cell.appendChild(cell.ownerDocument.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main", "w:p"));
        
        let r = p.getElementsByTagName("w:r")[0];
        if (!r) r = p.appendChild(cell.ownerDocument.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main", "w:r"));
        
        let t = r.getElementsByTagName("w:t")[0];
        if (!t) t = r.appendChild(cell.ownerDocument.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main", "w:t"));
        
        t.textContent = String(val || "");
        // 清理残余
        Array.from(cell.getElementsByTagName("w:t")).slice(1).forEach(x => x.textContent = "");
    }

    function doCheck(p, b) {
        Array.from(p.getElementsByTagName("w:t")).forEach(t => {
            if (/[（\(].*[）\)]/.test(t.textContent)) t.textContent = t.textContent.replace(/[（\(].*?[）\)]/, b ? "（√）" : "（  ）");
        });
    }

    function doScore(p, v) {
        Array.from(p.getElementsByTagName("w:r")).forEach(r => {
            const t = r.getElementsByTagName("w:t")[0];
            if (t && t.textContent.includes("成绩")) {
                t.textContent = t.textContent.replace(/(成绩[：:][\s_]*)[\d.]*(.*)/, `$1 ${v}      $2`);
            }
        });
    }
</script>
</body>
</html>